<!DOCTYPE html>
<html><head><script>
    const JS_ELT_ID = '__activity-js-data';
    const CSS_ELT_ID = '__activity-css-data';
    let initialized = false;
    let signature = Symbol();

    window.addEventListener('message', async e => {
        if (e.data.type === 'initialize') {
            if (!initialized) {
                initialized = true;
                signature = e.data.signature;
            }
            return;
        }

        // verify that the message is being sent by the activity
        if (e.data.signature !== signature) {
            return;
        }

        switch (e.data.type) {
            case 'html': {
                document.body.innerHTML = e.data.value;
                return;
            }
            case 'code': {
                document.getElementById(JS_ELT_ID)?.remove();
                const scriptElt = document.createElement('script');
                scriptElt.id = JS_ELT_ID;
                scriptElt.innerHTML = e.data.value;
                document.head.appendChild(scriptElt);
                return;
            }
            case 'css': {
                document.getElementById(CSS_ELT_ID)?.remove();
                const styleElt = document.createElement('style');
                styleElt.id = CSS_ELT_ID;
                styleElt.innerHTML = e.data.value;
                document.head.appendChild(styleElt);
                return;
            }
            case 'tests': {
                try {
                    const AsyncFunction = Object.getPrototypeOf(async () => {}).constructor;
                    console.log(e.data.code);
                    await AsyncFunction(e.data.code)();
                    window.parent.postMessage({ type: 'test-results', signature, success: true }, '*');
                }
                catch (e) {
                    window.parent.postMessage({ type: 'test-results', signature, success: false, message: e?.message ?? e }, '*');
                }
                return;
            }
        }
    });
    window.parent.postMessage({ type: 'activity-iframe-loaded' }, '*');
    // clean up
    document.currentScript.remove();
</script></head></html>